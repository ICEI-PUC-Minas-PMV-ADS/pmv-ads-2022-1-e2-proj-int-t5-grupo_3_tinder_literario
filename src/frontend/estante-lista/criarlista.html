<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M@TCHBOOK</title>
    <link rel="stylesheet" href="style/reset.css">
    <link rel="shortcute icon" href="imgs/icones/pena.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="style/style_menu.css">
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/styleimputscriarlista.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.css"/>

    <!-- Add the slick-theme.css if you want default styling -->
<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
<!-- Add the slick-theme.css if you want default styling -->
<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>
</head>

<body>

    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <img id="logo" src="img/imgs/icones/logomatchbook.png" alt="Logo do Matchbook">

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav ">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Minha Conta
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                <li><a class="dropdown-item" href="../gerenciarperfil/index.html">Gerenciar Perfil</a></li>
                                <li><a class="dropdown-item" href="gerListas.html">Gerenciar Lista</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="estantelivros.html">Livros</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../navlistas/listas.html">Listas</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../chat/index.html">Chat</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../inicial/homepage.html">Sair</a>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="containerlista">
            <div class="inputslista">
                <form id="register-form" action="">
                    <div class="full-box">
                        <label class="labelnomelista">Nome da Lista</label>
                        <input type="text" name="text" id="nomelista" placeholder="Digite o nome da sua lista"
                            data-min-length="2">
                    </div>
                    <div class="full-box">
                        <label class="labelnomelista" for="text">Descrição</label>
                        <textarea class="form-control" id="descricaolista" rows="2"
                            placeholder="Digite aqui uma breve descrição sobre sua lista" data-required
                            data-min-length="3" data-max-length="1000"></textarea>
                    </div>
            </div>

            <div class="buscarlviro">
                <div class="input-group mb-3" id="busca">
                    <input type="search" class="form-control" id="caixabusca" placeholder="Buscar Livro"
                        aria-label="Buscar Livro" aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button id="botaobusca" class="btn-outline-secondary" type="button"><img class="lupa"
                                src="img/lupa.png" alt="" onclick="buscaLivro()"> </button>
                    </div>
                </div>
            </div>
            <div class="sugestaolivros">

                <div class="sugestaolivros">
                    <span class="titulo">Livros Disponíveis</span>

                    <div id="livros-carrousel" style="margin-top: 10px" class="teste" data-slick='{"slidesToShow": 4, "slidesToScroll": 4}'>
                        
                        <div id="carrocel-item-div-1"></div>

                        



                    </div>
                    <div>

                        <div class="livrosadicionados">
                            <span class="titulo">Livros Adicionados</span>
                            <div id="livros-add" style="margin-top: 10px"></div>
                        </div>

                        <div class="botaosalvarlista">
                            <a href=""><button class="salvarlista" onclick="insercaoLista()">Salvar Lista</button></a>
                        </div>
                    </div>
    </main>

    <footer class="rodape" style="padding-top: 25px; padding-bottom: 5px; text-align: center;">
        <p class="text3"> © Copyright | Todos os direitos são reservados - M@TCHBOOK 2022</p>
    </footer>
    <script src="lib/jquery/jquery.min.js "></script>
    <script src="js/owl.carousel.min.js "></script>
    <script src="js/main.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    
    <script type="text/javascript" src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.7.1/slick.js"></script>

    <script>
        listaAdicionadas = []

        $(document).ready(function () {
            $('.owl-carousel').owlCarousel();
            console.log("A tela carregou!")
            getLivros(event);
        })

        
$('.teste').slick({
  dots: true,
  infinite: false,
  speed: 300,
  slidesToShow: 4,
  slidesToScroll: 4,
  responsive: [
    {
      breakpoint: 1024,
      settings: {
        slidesToShow: 3,
        slidesToScroll: 3,
        infinite: true,
        dots: true
      }
    },
    {
      breakpoint: 600,
      settings: {
        slidesToShow: 2,
        slidesToScroll: 2
      }
    },
    {
      breakpoint: 480,
      settings: {
        slidesToShow: 1,
        slidesToScroll: 1
      }
    }
    // You can unslick at a given breakpoint now by adding:
    // settings: "unslick"
    // instead of a settings object
  ]
});

        function limpaGrid() {
            let i = 1;
            while (i <= 6) {
                document.getElementById("carrocel-item-" + i).remove()
                i++;
            }
        }

        function limpaGridSelecionada() {
            let i = 1;
            while (i <= 6) {
                document.getElementById("carrocel-item-div-" + i).remove()
                i++;
            }
        }

        async function buscaLivro() {
            event.preventDefault();

            console.log("Função para processar a busca de Livro...");

            let nomeLivro = ""

            try {
                nomeLivro = document.getElementById("caixabusca").value;
            } catch (e) {
                console.error(e)
            }

            console.log("Chamando a api para BUSCAR O LIVRO...")



            fetch(`https://matchbookapi.herokuapp.com/api/v1/livro?nomeLivro=${nomeLivro}`, {
                method: "GET",
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Request-Headers': 'access-control-allow-origin,content-type',
                    'Access-Control-Request-Method': 'access-control-allow-origin,content-type'
                },
            }).then(res => {
                limpaGrid();
                this.getResponse(res);

            }).catch(err => {
                console.log("A resposta da API quebrou...")

                console.log(err)
            });
        }

        async function getLivros(event) {
            console.log("Função para processar o GET de Livros.")

            //event.preventDefault();


            console.log("Chamando a api para buscar os livros..")
            let response = {}

            fetch("https://matchbookapi.herokuapp.com/api/v1/livro", {
                method: "GET",
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Request-Headers': 'access-control-allow-origin,content-type',
                    'Access-Control-Request-Method': 'access-control-allow-origin,content-type'
                },
            }).then(res => {
                this.getResponse(res);
            }).catch(err => {
                console.log("A resposta da API quebrou...")

                console.log(err)
            });
        }

        function createDiv(element, id) {
            let i = 1;
            let principalDiv = document.getElementById(element)
            while (i <= 6) {
                let div = document.createElement("div")
                div.className = "row"
                div.id = id + i;
                principalDiv.appendChild(div)
                i++;
            }
        }

        function adicionarSugeridos(livro) {
            listaAdicionadas.push(livro)
            // limpaGridSelecionada()
            createDiv('livros-add', "carrocel-item-div-");
            let i = 1

            for (let livro of listaAdicionadas) {

                let imageTag = document.createElement('img')
                imageTag.src = livro.img_link
                imageTag.alt = ""
                imageTag.style = " margin-bottom: 10px; ";
                imageTag.style = " width: 240px; margin-right: 10px; ";

                if (i / 5 <= 1) {
                    principalDiv = document.getElementById('carrocel-item-div-1')
                }

               
                principalDiv.appendChild(imageTag)
                principalDiv.style = 'margin-bottom: 10px'

                i++;

            }
        }

        async function getResponse(res) {
            console.log("Esperando o callback da API... ")
            let response = []

            if (localStorage.getItem("listaSugerida") !== null) {
                response = JSON.parse(localStorage.getItem("listaSugerida"));
            }

            createDiv('livros-carrousel', "carrocel-item-");
            let i = 1
            let principalDiv;

            for (let livro of response) {
                let imageTag = document.createElement('img')
                imageTag.src = livro.img_link
                imageTag.alt = ""
                imageTag.style = "margin-bottom: 10px;"

                imageTag.style = "width: 240px; margin-right: 10px;"

                imageTag.addEventListener('click', function () {
                    adicionarSugeridos(livro)
                })

                if (i / 10 <= 1) {
                    principalDiv = document.getElementById('carrocel-item-1')
                }

             

                principalDiv.appendChild(imageTag)
                principalDiv.style = 'margin-bottom: 10px'

                i++;

            }

        }

        async function respostaInsercaoLista(res) {
            console.log("Esperando o callback da API... ")
            response = JSON.parse(await res.text());
            alert("Lista Criada com sucesso!")
            window.location.href = window.location.href.replace('/src/frontend/estante-lista/criarlista.html','/src/frontend/estante-lista/gerListas.html')

        }

        async function insercaoLista() {
            let response = {
                idUsuario: '',
                descricao: '',
                nome: '',
                livroList: []
            };

            let cache = JSON.parse(localStorage.getItem("cache-user"));
            response.idUsuario = cache.id;
            response.descricao = document.getElementById("descricaolista").value;
            response.nome = document.getElementById("nomelista").value;
            response.livroList = listaAdicionadas

            console.log(response)
            let baseURL = "http://localhost:32738"

            fetch(baseURL + "/api/v1/criar-lista", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': 'POST, GET, PUT, DELETE, OPTIONS',
                    'Access-Control-Request-Headers': 'access-control-allow-origin,content-type',
                    'Access-Control-Request-Method': 'access-control-allow-origin,content-type'
                },
                body: JSON.stringify(response)
            }).then(res => {
                respostaInsercaoLista(res)
            }).catch(err => {
                console.log("A resposta da API quebrou...")
                console.log(err)
            });
        }

    </script>
</body>

</html>