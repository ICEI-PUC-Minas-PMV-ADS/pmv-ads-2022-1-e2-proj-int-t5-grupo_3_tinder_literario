<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M@TCHBOOK</title>
    <link rel="stylesheet" href="reset.css">
    <link rel="shortcute icon" href="imgs/icones/pena.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./style/style_menu.css">
    <link rel="stylesheet" href="./style/stylelogin.css">
</head>

<body>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <img id="logo" src="img/logomatchbook.png" alt="Logo do Matchbook">
            </div>
        </nav>
    </header>

    <body>
        <div id="login-container">
            <h1>Recuperar Senha</h1>
            <form method="post">
                <label for="email">E-mail:</label>
                <input type="text" name="email" id="email" />
                <!-- Botão que irá abrir o modal -->
                <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#meuModal">Recuperar</button>
            </form>
            <!-- Modal -->
            <div id="meuModal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <!-- Conteúdo do modal-->
                    <div class="modal-content">
                        <form method="post" action="">
                            <h1>Cadastre-se uma nova senha para acessar o M@tchbook</h1>
                            <!-- Cabeçalho do modal -->
                            <div class="modal-header">
                                <h4 class="modal-title">Preencha os dados abaixo:</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <!-- Corpo do modal -->
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="email" class="required">E-mail</label>
                                    <input type="email" name="email" id="email" disabled>
                                </div>
                                <p></p>
                                <div class="half-box spacing">
                                    <label for="newPassword" class="required">Nova Senha</label>
                                    <input type="password" name="password" id="newPassword" placeholder="Digite sua nova senha" data-password-validate data-required>
                                </div>
                                <div class="half-box">
                                    <label for="confirmPassword" class="required">Confirmação de senha</label>
                                    <input type="password" name="confirmPassword" id="confirmPassword" placeholder="Digite novamente sua senha" data-equal="password">
                                </div>
                                <label for="token">Token:</label>
                                <input type="text" id="token" name="token" title="Password Token" />
                                <p class="form-actions">
                                    <div class="full-box" onclick="RealizeRegistry(event)">
                                        <input id="btn-submit" type="submit" value="Registrar">
                                    </div>
                                </p>
                                <div id="register-container">
                                    <a href="../inicial/homepage.html" style="text-decoration: none; color: #E2A165" target="_blank">Página
                                inicial</a>
                                </div>

                            </div>
                    </div>
                </div>
                </form>
    </body>
    <script>
        async function processaForm(event) {
            console.log("Função para processar o formulário da recuperacao da senha...")

            event.preventDefault();

            var username = document.getElementById('email').value;

            console.log("Obtem os dados de email a partir da recuperacao da senha...")

            let form = {
                email: "",
            }

            form.email = username;

            console.log("Chamando a api para verficar email...")
            let response = {}

            let baseURL = "https://matchbookapi.herokuapp.com"

            fetch(baseURL + `/api/v1/verifica-email?email=${form.email}`, {
                method: "GET",
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
                    'Access-Control-Request-Headers': 'access-control-allow-origin,content-type',
                    'Access-Control-Request-Method': 'access-control-allow-origin,content-type'
                },
            }).then(res => {
                this.getResponse(res);

            }).catch(err => {
                console.log("A resposta da API quebrou...")

                console.log(err)
            });
        }


        async function getResponse(res) {
            console.log("Esperando o callback da API... ")

            response = JSON.parse(await res.text());

            if (response.existente) {
                localStorage.setItem('cache-user', JSON.stringify(response));
                console.log(window.location.href)
                window.location.href = window.location.href.replace('/src/frontend/recuperar-senha/index.html', '/src/frontend/cadastro-nova-senha/index.html')
            } else {
                alert("Email não encontrado na base!")
            }
        }

        $(document).ready(function() {
            console.log("A tela carregou!")
            getUser(event);
        })


        async function getUser(event) {
            let user = JSON.parse(localStorage.getItem("cache-user"));
            document.querySelector('#email').value = user.email

        }

        function passwordSubValidate(password, subpassword) {
            return password === subpassword ? true : false;
        }

        function printMessage(input) {
            alert(input);
        }

        async function RealizeRegistry(event) {
            event.preventDefault();

            console.log("Função para processar o formulário de CADASTRO...");

            let user = {
                id: "",
                senha: "",
            };

            let cachedUser = JSON.parse(localStorage.getItem("cache-user"));


            try {
                user.senha = document.querySelector('#password').value;
                user.id = cachedUser.id;
            } catch (e) {
                console.error(e)
            }

            let valid = true;

            valid = passwordValidate(user.senha) ? passwordSubValidate(document.querySelector('#password').value, document.querySelector('#passwordconfirmation').value) : false;

            if (valid) {
                console.log("Formulário Válido...")

                console.log("Chamando a api para REALIZAR O CADASTRO...")
                let baseURL = "https://matchbookapi.herokuapp.com"

                fetch(baseURL + "/api/v1/atualiza-usuario", {
                    method: "PATCH",
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS, PATCH',
                        'Access-Control-Request-Headers': 'access-control-allow-origin,content-type',
                        'Access-Control-Request-Method': 'access-control-allow-origin,content-type'
                    },
                    body: JSON.stringify(user)
                }).then(res => {
                    console.log("Esperando o callback da API... ")

                    getResponse(res);
                }).catch(err => {
                    console.log("A resposta da API quebrou...")

                    console.log(err)
                    user = {
                        id: "",
                        senha: "",
                    };
                });
            }
        }


        function passwordValidate(input) {
            let charArr = input.split("");
            let uppercases = 0;
            let numbers = 0;

            for (let i = 0; charArr.length > i; i++) {
                if (charArr[i] === charArr[i].toUpperCase() && isNaN(parseInt(charArr[i]))) {
                    uppercases++;
                } else if (!isNaN(parseInt(charArr[i]))) {
                    numbers++;
                }
            }

            if (uppercases === 0 || numbers === 0) {
                let errorMessage = `A senha precisa um caractere maiúsculo e um número`;

                this.printMessage(errorMessage);
                return false
            }

            return true;
        }

        async function getResponse(res) {
            console.log("Esperando o callback da API... ")

            response = JSON.parse(await res.text());

            console.log("Callback da API chegou: " + JSON.stringify(response))

            user = {
                id: "",
                senha: "",
            };

            if (response.status) {
                alert('Alteração realizada com sucesso!');
                window.location.href = window.location.href.replace('/src/frontend/cadastro-nova-senha/index.html', '/src/frontend/login/index.html')
            } else {
                alert('Erro ao realizar Alteração no cadastro!');
            }
        }

        <!--Pedro veja de podemos utilizar isso para resgatar senha
        @ {
            newPassword = Request["newPassword"];
            confirmPassword = Request["confirmPassword"];
            token = Request["token"];
            if IsPost {
                // input testing is ommitted here to save space
                retunValue = ResetPassword(token, newPassword);
            }
        } -->
    </script>

</html>
